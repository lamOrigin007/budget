# Бюджеты и Carryover

## Типы бюджетов
| Тип | Период | Применение |
|-----|--------|------------|
| `monthly` | Календарный месяц | Основной сценарий (по умолчанию). |
| `weekly` | Неделя (понедельник-воскресенье) | Для коротких циклов расходов. |
| `custom` | Пользовательский интервал (`start_date`, `end_date`) | Сезонные или проектные бюджеты. |

## Правила создания
1. Бюджет уникален по `(family_id, period_type, start_date)`.
2. Допускается перекрытие только для разных типов (например, `monthly` + `custom`).
3. В каждом бюджете определяется базовая валюта (`currency`).
4. Каждая категория может иметь лимит (`budget_items.limit_amount`).

## Carryover (перенос остатка)
- Флаг `budget_items.carryover = true` включает перенос.
- Остаток рассчитывается как `limit_amount - spent_amount` (минимум 0).
- Перенос осуществляется при закрытии периода в `POST /api/v1/budgets/{id}/close`.
- Остаток переносится в следующий активный бюджет той же категории.

### Пример переноса
| Категория | Лимит | Потрачено | Остаток | Перенос в следующий месяц |
|-----------|-------|-----------|---------|---------------------------|
| Продукты | 30 000 ₽ | 27 500 ₽ | 2 500 ₽ | `+2 500 ₽` к лимиту июля |
| Транспорт | 5 000 ₽ | 5 800 ₽ | 0 ₽ | Перенос не выполняется (перерасход) |

## Закрытие периода
1. Проверить, что все транзакции до `end_date` учтены.
2. Зафиксировать фактические траты `spent_amount` для каждой категории.
3. Вычислить переносы и создать записи `carryover_log`:
   ```json
   {
     "budget_id": "bud_2024_06",
     "category_id": "cat_food",
     "carryover_minor": 250000,
     "target_budget_id": "bud_2024_07"
   }
   ```
4. Обновить статус бюджета на `closed`, указать `closed_at` и автора.

## Изменение лимитов
- В течение активного периода допускается изменение `limit_amount`, что фиксируется в `budget_change_log`.
- При уменьшении лимита ниже уже потраченной суммы пользователь получает предупреждение (`budget.limit_warning`).
- История изменений отображается в UI и сохраняется для аудита.

## Пересчёт мультивалютных бюджетов
- Все значения конвертируются в валюту бюджета по курсу на дату транзакции.
- При смене валюты бюджета создаётся новый бюджет (перевыпуск), старый закрывается.

## Автоматизация
- Поддерживаются автоправила: «копировать прошлый месяц», «увеличивать лимит на инфляцию».
- Carryover может накапливаться до `carryover_cap` (опциональное поле), после превышения остаток сбрасывается в Goals.

## Примеры API
```http
POST /api/v1/budgets
{
  "period": "monthly",
  "start_date": "2024-07-01",
  "currency": "RUB",
  "items": [
    {"category_id": "cat_food", "limit_minor": 300000, "carryover": true},
    {"category_id": "cat_transport", "limit_minor": 50000, "carryover": false}
  ]
}
```

```http
POST /api/v1/budgets/{id}/close
{
  "closed_at": "2024-06-30T21:00:00Z",
  "force": false
}
```


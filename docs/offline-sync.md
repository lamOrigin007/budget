# Офлайн-синхронизация

## Общие принципы
- Клиенты (Android/iOS) хранят локальный кэш в базе (Room/CoreData) для категорий, счетов и транзакций.
- Каждое изменение сопровождается `clientMutationId` и `last_modified_at` (UTC).
- Синхронизация двухфазная: отправка локальных изменений → получение изменений сервера.

## Алгоритм Last Write Wins
1. Клиент отправляет пачку мутаций `POST /api/v1/sync` с `clientMutationId`.
2. Backend сравнивает `last_modified_at` с серверной версией.
3. Если клиентская метка больше — запись обновляется, в противном случае отправляется конфликт.
4. В ответе сервер возвращает актуальное состояние и список конфликтов.

## Формат запроса
```json
{
  "device_id": "ios-123",
  "last_sync_at": "2024-06-20T07:30:00Z",
  "mutations": [
    {
      "clientMutationId": "txn-uuid-1",
      "entity": "transaction",
      "operation": "upsert",
      "payload": {
        "transaction_id": "local-1",
        "account_id": "acc-cash",
        "amount_minor": -1299,
        "currency": "EUR",
        "occurred_at": "2024-06-19T10:00:00Z",
        "last_modified_at": "2024-06-20T07:15:00Z"
      }
    },
    {
      "clientMutationId": "acc-uuid-1",
      "entity": "account",
      "operation": "upsert",
      "payload": {
        "account_id": "acc-travel-wallet",
        "name": "Путешествия",
        "type": "wallet",
        "currency": "EUR",
        "balance_minor": 0,
        "last_modified_at": "2024-06-20T07:10:00Z"
      }
    }
  ]
}
```

## Формат ответа
```json
{
  "server_time": "2024-06-20T07:31:05Z",
  "applied": [
    {"clientMutationId": "txn-uuid-1", "status": "ok", "server_id": "txn_01HZ..."}
  ],
  "conflicts": [
    {
      "clientMutationId": "txn-uuid-2",
      "entity": "transaction",
      "reason": "server_newer",
      "server_payload": {
        "transaction_id": "txn_01HY...",
        "last_modified_at": "2024-06-20T07:20:00Z"
      }
    }
  ],
  "delta": {
    "transactions": [
      {
        "transaction_id": "txn_01HY...",
        "amount_minor": -1500,
        "last_modified_at": "2024-06-20T07:20:00Z"
      }
    ],
    "budgets": []
  }
}
```

## Таблица конфликтов
| Код | Описание | Действие клиента |
|-----|----------|------------------|
| `server_newer` | На сервере более свежая версия | Обновить локальную запись, уведомить пользователя. |
| `deleted_on_server` | Запись удалена на сервере | Удалить локальную копию. |
| `validation_failed` | Мутация не прошла валидацию | Показать ошибку и дать исправить. |
| `permission_denied` | Недостаточно прав | Скрыть локальную запись или запросить повышенные права. |

## Конфликты транзакций
- При одновременном редактировании сохраняется последняя правка по `last_modified_at`.
- Локальные вложения (`attachments`) загружаются отдельно; если загрузка провалилась, синк повторяет до успеха.

## Очередь задач
- Мутации сохраняются в локальной очереди до подтверждения `status=ok`.
- Успешно применённые мутации помечаются как синхронизированные и удаляются.

## Политика хранения истории синка
- Сервер хранит журнал изменений 30 дней (`sync_journal`).
- Клиент хранит `last_sync_token`; при длительном офлайне (>30 дней) выполняется полная репликация.
- При полной репликации сервер возвращает актуальные состояния счетов с рассчитанными остатками, чтобы мобильные клиенты могли показать балансы без повторных запросов.


# Мультивалютность и курсы валют

## Основные принципы
- Все суммы хранятся в minor units (`amount_minor`, `BIGINT`).
- Каждая операция содержит валюту (`currency`, ISO 4217) и курс (`exchange_rate`) относительно базовой валюты семьи.
- В базовой валюте семьи дублируется поле `amount_base_minor` для консистентной аналитики.

## Источники курсов
| Источник | Частота обновления | SLA | Примечание |
|----------|--------------------|-----|-----------|
| Европейский Центробанк (ECB) | Ежедневно (16:00 CET) | 99% | Курс закрытия дня, только по рабочим дням. |
| Fixer.io (платный) | Ежечасно | 99.5% | Используется для realtime конвертации и исторических данных. |
| Ручной ввод | По требованию | n/a | Для экзотических валют или коррекции расхождений. |

- Если курс недоступен, операция откладывается в очередь `exchange_rate_pending` и повторяется через 5 минут.
- Для мобильных клиентов кэшируются курсы за последние 30 дней.

## Алгоритм расчёта
1. Определяем базовую валюту семьи (`families.currency_base`).
2. Если валюта операции совпадает с базовой — `exchange_rate = 1`, `amount_base_minor = amount_minor`.
3. Иначе получаем курс на дату `occurred_at` (округление до 6 знаков).
4. Пересчёт: `amount_base_minor = round(amount_minor * exchange_rate)`.
5. Курс и пересчитанная сумма фиксируются и не изменяются задним числом.

### Округление
- Используется банковское округление до 2 знаков в целевой валюте.
- В minor units округление происходит до целых в базовой валюте.
- Пример: 12500 KZT при курсе 0.205673 → `12500 * 0.205673 = 2570.9125` → `2571` (minor units RUB).

## Курсы и исторические данные
```sql
CREATE TABLE exchange_rates (
  id UUID PRIMARY KEY,
  base CHAR(3) NOT NULL,
  quote CHAR(3) NOT NULL,
  rate NUMERIC(18,6) NOT NULL,
  as_of DATE NOT NULL,
  source TEXT NOT NULL,
  UNIQUE (base, quote, as_of)
);
```
- Храним курсы в обе стороны: если получен `EUR -> USD`, обратный вычисляется на лету.
- Допускается хранение дополнительных метаданных (`confidence`, `source_id`).

## SLA для обновления курсов
- Курсы должны обновиться в течение 10 минут после публикации источника.
- Если SLA нарушен, генерируется событие `exchange_rate.delayed` (см. `docs/events.md`).

## Комиссии и спред
- Дополнительный спред банка можно хранить в `exchange_rate_fee_bps`.
- При импорте выписки допускается указание `rate_override` — приоритетнее глобального курса.

## Пример JSON операции
```json
{
  "transaction_id": "txn_01HZY3...",
  "currency": "USD",
  "amount_minor": -4599,
  "exchange_rate": 0.912345,
  "amount_base_minor": -4199,
  "occurred_at": "2024-06-17T12:30:00Z",
  "account_currency": "USD",
  "family_currency": "EUR"
}
```


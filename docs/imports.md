# Импорт выписок (CSV/Excel)

## Профили импорта
| Поставщик | Формат | Пример файла | Особенности |
|-----------|--------|--------------|-------------|
| Generic CSV | CSV (UTF-8) | `date,amount,description` | Настраиваемое сопоставление колонок, поддержка дебет/кредит через знак. |
| Tinkoff RU | XLSX | `Дата операции` | Парсинг листа `Operations`, поддержка двух колонок суммы (в валюте и в рублях). |
| Revolut | CSV (UTF-8) | `Date,Amount,Currency,Description` | Поддержка мультивалютных переводов, разнесение по счетам. |

### Определение профиля
1. Пользователь выбирает банк из справочника.
2. Если не найден — выбирается Generic CSV и запускается мастер сопоставления.
3. Профиль хранит:
   ```json
   {
     "id": "tinkoff-xlsx-v1",
     "delimiter": ";",
     "skip_rows": 1,
     "date_format": "dd.MM.yyyy",
     "columns": {
       "occurred_at": "Дата операции",
       "amount": "Сумма операции",
       "currency": "Валюта",
       "description": "Описание"
     },
     "decimal_separator": ",",
     "timezone": "Europe/Moscow"
   }
   ```
4. Профили версионируются (`*-v1`, `*-v2`). При изменении структуры файла создаётся новая версия.

## Контракт загрузки
```http
POST /api/v1/imports
Content-Type: multipart/form-data
```
Тело содержит файл и JSON-конфигурацию сопоставления. Ответ:
```json
{
  "import_id": "imp_01HZY2...",
  "status": "pending_validation",
  "total_rows": 124,
  "duplicates": 3,
  "warnings": [
    {"row": 42, "code": "missing_category", "message": "Категория не распознана"}
  ]
}
```

## Валидация и ошибки
- **Формат**: проверка расширения, кодировки, размера (<10 МБ).
- **Обязательные поля**: дата, сумма, счёт/категория (если требуется).
- **Ошибки** возвращаются массивом объектов `{row, code, message, details}`.
- **Предупреждения** не блокируют импорт, пользователь может скорректировать вручную.

Пример ошибки:
```json
{
  "errors": [
    {
      "row": 15,
      "code": "invalid_amount",
      "message": "Сумма не может быть пустой",
      "details": {
        "value": "--"
      }
    }
  ]
}
```

## Идемпотентность
- Каждая загрузка должна указывать `Idempotency-Key` (UUID) в заголовке.
- Повтор запроса с тем же ключом возвращает предыдущий результат (идемпотентность retry).
- Для строк импорта используется хэш `sha256(family_id + account_id + occurred_at + amount + description)` — позволяет выявить дубликаты.

## Проведение транзакций
- После подтверждения пользователь запускает `POST /api/v1/imports/{id}/commit`.
- Backend создаёт транзакции пачками по 100 записей.
- Для мультивалютных выписок обязательно указание валюты в каждой строке.
- Логи действий пишутся в `audit_logs` (`import_committed`).

## Отмена импорта
- `DELETE /api/v1/imports/{id}` отменяет незавершённый импорт.
- Если импорт уже проведён, откат возможен через `POST /api/v1/imports/{id}/rollback`, что помечает созданные транзакции как удалённые (`deleted_at`).

